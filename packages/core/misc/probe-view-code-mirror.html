<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script type="importmap">JB_IMPORT_MAP</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/searchcursor.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/search.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/dialog/dialog.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/brace-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/xml-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/indent-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/comment-fold.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/dialog/dialog.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.css">
<style>
html, body { height: 100%; margin: 0; padding: 0; }
.CodeMirror { height: 100%; font-size: 12px; border: 1px solid #ddd; }
</style>
</head>
<body>
  <div id="show" style="height: 100vh;"></div>
  <script type="module">
import { coreUtils } from '@jb6/core'
import { reactUtils } from '@jb6/react'
import '@jb6/react/tests/react-testers.js'
import '@jb6/core/misc/import-map-services.js'
import '@jb6/core/misc/probe.js'
import '@jb6/core/misc/pretty-print.js'

const { h, L, useState, useEffect, useRef, createRoot, prettyPrintNode } = reactUtils

async function run() {
    const projectRoot = await coreUtils.calcRepoRoot()
    const urlParams = new URLSearchParams(window.location.search);
    const filePath = urlParams.get('filePath') || '/jb6_packages/react/tests/react-tests.js'
    const fullFilePath = `${projectRoot}${filePath}`
    const path = urlParams.get('path') || 'reactTest.HelloWorld~impl~expectedResult'
    
    const render = (component) => createRoot(document.getElementById('show')).render(component)
    render(h(LoadingView, { path, filePath }))
    
    let result, error
    try {
        result = await coreUtils.runProbeCli(path, {entryPointPaths: fullFilePath})
        error = result.error || result.result?.error
    } catch (e) {
        error = e
    }

    if (error) {
        render(h(ErrorView, { error: error.stderr || error, path, filePath }))
    } else {
        render(h(probeResultView, result))
    }
}
run()

function LoadingView({ path, filePath }) {
    const [dots, setDots] = useState('')
    
    useEffect(() => {
        const interval = setInterval(() => {
            setDots(prev => prev.length >= 3 ? '' : prev + '.')
        }, 500)
        return () => clearInterval(interval)
    }, [])
    
    return h('div:w-full h-96 flex items-center justify-center bg-gray-50', {},
        h('div:text-center', {},
            h('div:text-lg font-semibold mb-2', {}, `Calculating probe${dots}`),
            h('div:text-sm text-gray-600', {}, path),
            h('div:text-xs text-gray-400 mt-2', {}, 'Please wait...')
        )
    )
}

function ErrorView({ error, path, filePath }) {
    return h('div:w-full h-96 flex items-center justify-center bg-red-50', {},
        h('div:text-center max-w-2xl', {},
            h('h3:text-lg font-semibold text-red-800 mb-4', {}, 'Probe Error'),
            h('div:bg-white p-4 rounded border', {},
                h('pre:text-xs text-red-700 overflow-auto', {}, 
                    typeof error === 'string' ? error : JSON.stringify(error, null, 2))
            ),
            h('button:bg-blue-600 text-white px-4 py-2 rounded mt-4', {
                onClick: () => window.location.reload()
            }, 'Retry')
        )
    )
}

function probeResultView(props) {
    const { probeRes, cmd: _cmd, error, projectDir } = props
    const cmd = [`cd ${projectDir}`, _cmd].join('\n')
    
    const [showJson, setShowJson] = useState(false)
    const [showCmd, setShowCmd] = useState(false)
    const [showError, setShowError] = useState(false)
    
    const getShortName = (id) => id.split('>').pop()
    const getPathElements = (path) => path.split('~')
    const getVisitsForPath = () => probeRes.visits[probeRes.probePath] || 0
    const getTestFailures = () => {
        const failures = []
        Object.keys(probeRes.circuitRes).forEach(key => {
            if (probeRes.circuitRes[key]?.testFailure) {
                failures.push(probeRes.circuitRes[key].testFailure)
            }
        })
        return failures
    }

    const getActiveView = () => {
        if (showJson) return 'json'
        if (showCmd) return 'cmd'
        if (showError) return 'error'
        return 'results'
    }

    const setActiveView = (view) => {
        setShowJson(view === 'json')
        setShowCmd(view === 'cmd')
        setShowError(view === 'error')
    }

    return h('div:w-full h-full flex flex-col overflow-auto bg-white border rounded shadow-sm text-xs', {},
        // Header with tabs
        h('div:sticky top-0 bg-white border-b px-3 py-2 flex items-center justify-between', {
            className: !probeRes.circuitRes.success ? 'bg-red-50 border-red-200' : ''
        },
            h('div:flex items-center gap-2', {},
                probeRes.circuitRes.success 
                    ? h('L:Check', { className: 'text-green-600' })
                    : h('L:X', { className: 'text-red-600' }),
                h('span:font-semibold', {
                    className: !probeRes.circuitRes.success ? 'text-red-800' : ''
                }, getShortName(probeRes.circuitCmpId)),
                h('span:text-gray-500', {}, `(${getVisitsForPath()}v)`),
                h('span:bg-blue-100 text-blue-700 px-1 rounded', {}, `${probeRes.totalTime}ms`),
                h('span:bg-gray-100 text-gray-600 px-1 rounded', {}, `${probeRes.logs.length}L`)
            ),
            h('div:flex gap-1', {},
                h('button:text-blue-600 hover:text-blue-800 text-xs px-1 rounded', {
                    className: getActiveView() === 'json' ? 'bg-blue-100' : '',
                    onClick: () => setActiveView(getActiveView() === 'json' ? 'results' : 'json')
                }, 'JSON'),
                cmd && h('button:text-purple-600 hover:text-purple-800 text-xs px-1 rounded', {
                    className: getActiveView() === 'cmd' ? 'bg-purple-100' : '',
                    onClick: () => setActiveView(getActiveView() === 'cmd' ? 'results' : 'cmd')
                }, 'CMD'),
                h('a', { href: location.href }, 'Browser'),
                error && h('button:text-red-600 hover:text-red-800 text-xs px-1 rounded', {
                    className: getActiveView() === 'error' ? 'bg-red-100' : '',
                    onClick: () => setActiveView(getActiveView() === 'error' ? 'results' : 'error')
                }, 'ERR')
            )
        ),

        // Path display
        h('div:text-xs text-gray-600 px-3 py-1 border-b truncate', { 
            title: probeRes.probePath 
        }, ...getPathElements(probeRes.probePath).map((elem, i, arr) => 
            i === arr.length - 1 
                ? h('span:font-medium', { key: i }, elem)
                : [h('span', { key: `${i}-elem` }, elem), h('span:mx-0.5', { key: `${i}-sep` }, '~')]
        ).flat()),

        // Error display
        (probeRes.errors.length > 0 || getTestFailures().length > 0) && 
        h('div:bg-red-50 border-l-2 border-red-500 px-3 py-1 text-red-700', {},
            h('div:font-medium', {}, 'Errors'),
            probeRes.errors.length > 0 && 
            h('pre:text-xs overflow-auto mb-1', {}, JSON.stringify(probeRes.errors, null, 1)),
            ...getTestFailures().map((failure, i) => 
                h('div:text-xs mb-1', { key: i },
                    h('span:font-medium', {}, failure.code + ': '),
                    h('span:font-mono', {}, failure.url || failure.message || 'Test failure')
                )
            )
        ),

        // Content based on active view
        getActiveView() === 'json' ? 
        h('div:p-3', {},
            h('pre:bg-gray-900 text-green-400 p-2 rounded text-xs overflow-auto max-h-64', {}, 
                JSON.stringify(probeRes, null, 2))
        ) : getActiveView() === 'cmd' ? 
        h('div:p-3', {},
            h('div:mb-2 flex items-center justify-between', {},
                h('span:font-medium text-purple-800', {}, `cd ${projectDir}`),
                h('button:text-purple-600 hover:text-purple-800 text-xs px-2 py-1 border border-purple-300 rounded hover:bg-purple-50', {
                    onClick: () => navigator.clipboard.writeText(cmd)
                }, 'Copy')
            ),
            h('pre:bg-purple-50 border border-purple-200 p-2 rounded text-xs overflow-auto max-h-64 font-mono', {}, cmd)
        ) : getActiveView() === 'error' ? 
        h('div:p-3', {},
            h('div:mb-2 font-medium text-red-800', {}, 'Error:'),
            h('pre:bg-red-50 border border-red-200 p-2 rounded text-xs overflow-auto max-h-64', {}, 
                typeof error === 'string' ? error : JSON.stringify(error, null, 2))
        ) : 
        h('div:p-3 flex-1 flex flex-col overflow-auto', {},
            probeRes.result.length === 0 
                ? h('div:text-gray-500 text-center py-4', {}, 'No results')
                : probeRes.result.map((result, index) => 
                    h(CodeMirrorInputOutput, { key: index, ...result, index })
                )
        )
    )
}

function CodeMirrorInputOutput({ in: In, out, index }) {
    const inputRef = useRef()
    const outputRef = useRef()
    const containerRef = useRef()
    const [inputWidth, setInputWidth] = useState(50)
    
    // Detect if input data is HTML string
    const inputData = In.data || In
    const isHtmlString = typeof inputData === 'string' && inputData.trim().startsWith('<') && inputData.includes('>')
    
    const handleLayoutChange = (newInputWidth) => {
        setInputWidth(newInputWidth)
        setTimeout(() => {
            const mainContainer = containerRef.current
            if (!mainContainer) return
            
            const totalWidth = mainContainer.offsetWidth
            const totalHeight = mainContainer.offsetHeight - 40 // Account for headers
            const paddingAndBorder = 20 // Account for padding (p-2 = 8px each side) + border (1px each side) = ~20px total
            const availableWidth = totalWidth - paddingAndBorder
            const inputEditorWidth = availableWidth * newInputWidth / 100
            const outputEditorWidth = availableWidth - inputEditorWidth
            
            if (inputRef.current?.codeMirrorInstance) {
                inputRef.current.codeMirrorInstance.setSize(inputEditorWidth, totalHeight)
                inputRef.current.codeMirrorInstance.refresh()
            }
            if (outputRef.current?.codeMirrorInstance) {
                outputRef.current.codeMirrorInstance.setSize(outputEditorWidth, totalHeight)
                outputRef.current.codeMirrorInstance.refresh()
            }
        }, 0)
    }
    
    useEffect(() => {
        if (inputRef.current && !inputRef.current.codeMirrorInstance) {
            let inputValue
            if (isHtmlString) {
                const tempDiv = document.createElement('div')
                tempDiv.innerHTML = inputData                
                inputValue = prettyPrintNode(tempDiv)
            } else {
                inputValue = coreUtils.prettyPrint(inputData)
            }
            
            inputRef.current.codeMirrorInstance = CodeMirror(inputRef.current, {
                value: inputValue,
                mode: isHtmlString ? 'xml' : 'javascript',
                readOnly: true,
                lineNumbers: true,
                foldGutter: true,
                gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
                extraKeys: {
                    "Ctrl-F": "findPersistent",
                    "Cmd-F": "findPersistent",
                    "Ctrl-Q": function(cm){ cm.foldCode(cm.getCursor()); },
                    "Cmd-Q": function(cm){ cm.foldCode(cm.getCursor()); }
                }
            })
        }
        
        if (outputRef.current && !outputRef.current.codeMirrorInstance) {
            const outputValue = typeof out === 'object' 
                ? coreUtils.prettyPrint(out)
                : String(out)
                
            outputRef.current.codeMirrorInstance = CodeMirror(outputRef.current, {
                value: outputValue,
                mode: 'javascript',
                readOnly: true,
                lineNumbers: true,
                foldGutter: true,
                gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
                extraKeys: {
                    "Ctrl-F": "findPersistent",
                    "Cmd-F": "findPersistent",
                    "Ctrl-Q": function(cm){ cm.foldCode(cm.getCursor()); },
                    "Cmd-Q": function(cm){ cm.foldCode(cm.getCursor()); }
                }
            })
        }
        
        // Initial layout
        handleLayoutChange(50)
    }, [In, out, isHtmlString, inputData])
    
    // Add resize handler for CodeMirror refresh
    useEffect(() => {
        const handleResize = () => {
            // Recalculate and resize both editors
            handleLayoutChange(inputWidth)
        }
        
        window.addEventListener('resize', handleResize)
        return () => window.removeEventListener('resize', handleResize)
    }, [inputWidth])
    
    // Unified layout for all cases
    return h('div:flex flex-1 min-h-96 border rounded p-2 mb-2', { ref: containerRef },
        h('div:flex flex-col', {},
            h('div:flex items-center justify-center gap-1 mb-1 h-8', {},
                h('span:font-medium text-gray-600', {}, 'Input:'),
                h('div:flex gap-0.5', {},
                    h('button:text-xs px-1 py-0 border rounded hover:bg-gray-50 text-gray-600 leading-none', {
                        onClick: () => handleLayoutChange(20),
                        title: 'Narrow input'
                    }, '⟨'),
                    h('button:text-xs px-1 py-0 border rounded hover:bg-gray-50 text-gray-600 leading-none', {
                        onClick: () => handleLayoutChange(50),
                        title: 'Equal split'
                    }, '▣'),
                    h('button:text-xs px-1 py-0 border rounded hover:bg-gray-50 text-gray-600 leading-none', {
                        onClick: () => handleLayoutChange(80),
                        title: 'Wide input'
                    }, '⟩')
                )
            ),
            h('div:h-full', { ref: inputRef })
        ),
        
        h('div:flex flex-col', {},
            h('div:flex items-center justify-center gap-1 mb-1 h-8', {},
                h('span:font-medium text-gray-600', {}, 'Output:'),
                out === true 
                    ? h('L:Check', { className: 'text-green-600', size: 16 })
                    : out === false 
                        ? h('L:X', { className: 'text-red-600', size: 16 })
                        : null
            ),
            h('div:h-full', { ref: outputRef })
        )
    )
}
    </script>
</body>
</html>