<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script type="importmap">JB_IMPORT_MAP</script>

<!-- CodeMirror -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/searchcursor.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/search.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/dialog/dialog.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/brace-fold.min.js"></script>
<script src="https://cdnjs.cloudfleare.com/ajax/libs/codemirror/5.65.2/addon/fold/xml-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/indent-fold.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/comment-fold.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/dialog/dialog.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.css">

<style>
  html, body { height: 100%; margin: 0; padding: 0; }
  .CodeMirror { height: 100%; font-size: 12px; border: 1px solid #ddd; }
</style>
</head>
<body>
  <div id="show" style="height: 100vh;"></div>

  <script type="module">
import { coreUtils } from '@jb6/core'
import { reactUtils } from '@jb6/react'
import '@jb6/react/tests/react-testers.js'
import '@jb6/core/misc/import-map-services.js'
import '@jb6/core/misc/probe.js'
import '@jb6/core/misc/pretty-print.js'

const { h, L, useState, useEffect, useRef, createRoot, prettyPrintNode } = reactUtils

/** ---------------- boot ---------------- **/
async function run() {
  const { importMapsInCli } = JB_IMPORT_MAP
  jb.coreRegistry.importMapsInCli = importMapsInCli

  const projectRoot = await coreUtils.calcRepoRoot()
  const urlParams = new URLSearchParams(window.location.search)
  const filePath = urlParams.get('filePath') || '/jb6_packages/react/tests/react-tests.js'
  const fullFilePath = `${projectRoot}${filePath}`
  const path = urlParams.get('path') || 'reactTest.HelloWorld~impl~expectedResult'

  const render = (c) => createRoot(document.getElementById('show')).render(c)
  render(h(LoadingView, { path }))

  let result, error
  try {
    result = await coreUtils.runProbeCli(path, { entryPointPaths: fullFilePath })
    error = result.error || result.probeRes?.error
  } catch (e) { error = e }

  // Attach testRes for views that need it (e.g., workflow)
  result = result || {}
  result.testRes = result?.probeRes?.circuitRes?.testRes

  if (error) {
    render(h(ErrorView, { ...(result || {}), error: error.stderr || error, path, filePath }))
  } else {
    render(h(ProbeResultView, result))
  }
}
run()

/** ---------------- basic views ---------------- **/
function LoadingView({ path }) {
  const [dots, setDots] = useState('')
  useEffect(() => {
    const i = setInterval(() => setDots(p => p.length >= 3 ? '' : p + '.'), 500)
    return () => clearInterval(i)
  }, [])
  return h('div:w-full h-96 flex items-center justify-center bg-gray-50', {},
    h('div:text-center', {},
      h('div:text-lg font-semibold mb-2', {}, `Calculating probe${dots}`),
      h('div:text-sm text-gray-600', {}, path),
      h('div:text-xs text-gray-400 mt-2', {}, 'Please wait...')
    )
  )
}

function ErrorView({ error, cmd }) {
  return h('div:w-full h-96 flex items-center justify-center bg-red-50 flex-col', {},
    h('div:text-center', {},
      h('h3:text-lg font-semibold text-red-800 mb-4', {}, 'Probe Error'),
      h('div:bg-white p-4 rounded border', {},
        h('pre:text-xs text-red-700 overflow-auto', {}, typeof error === 'string' ? error : JSON.stringify(error, null, 2))
      ),
      h('button:bg-blue-600 text-white px-4 py-2 rounded mt-4', { onClick: () => window.location.reload() }, 'Retry')
    ),
    h('a:text-xs mt-2', { href: location.href }, 'Browser'),
    cmd && h('pre:bg-gray-900 text-green-400 p-3 rounded text-xs overflow-auto max-h-64 font-mono border border-gray-600 whitespace-pre-wrap mt-3', {}, `$ ${cmd}`)
  )
}

/** ---------------- declarative wrapper ---------------- **/
function ProbeResultView(props) {
  const { probeRes, cmd: _cmd, error, projectDir, testRes } = props
  const cmd = [`cd ${projectDir}`, _cmd].join('\n')

  // Small status bits
  const success = probeRes?.circuitRes?.success
  const visits = probeRes?.visits?.[probeRes?.probePath] || 0
  const totalTime = probeRes?.totalTime
  const logsCount = probeRes?.logs?.length || 0
  const titleShort = (probeRes?.circuitCmpId || '').split('>').pop() || ''

  // ---- Declarative views list ----
  // To add new tabs, push an object here. Dynamic views: set jsFile + renderDynamic (export name).
  const views = [
    { id: 'results',  tabTitle: 'RES',  render: renderResults },
    { id: 'json',     tabTitle: 'JSON', render: renderJson },
    { id: 'cmd',      tabTitle: 'CMD',  render: renderCmd,   condition: p => !!_cmd },
    { id: 'error',    tabTitle: 'ERR',  render: renderError, condition: p => !!error },
    // Dynamic workflow view
    { id: 'ultra',    tabTitle: 'UM', jsFile: './ultra-log-view.js',     renderDynamic: 'UltraMsgView',   condition: p => Array.isArray(p.testRes?.ultraMsgLog) && p.testRes.ultraMsgLog.length > 0 },
    { id: 'workflow', tabTitle: 'WF',   jsFile: './workflow-log-view.js', renderDynamic: 'WorkflowLogView', condition: p => !!testRes?.workflowLog }
  ]

  const availableViews = views.filter(v => !v.condition || v.condition(props))

  const [activeView, setActiveView] = useState((availableViews.find(v => v.renderDynamic) || {id:'results'}).id)

  // Lazy-loaded modules cache
  const [dynamicModules, setDynamicModules] = useState({})

  // Load dynamic modules (only for visible tabs)
  useEffect(() => {
    (async () => {
      const dynViews = availableViews.filter(v => v.jsFile)
      if (!dynViews.length) return
      const mods = {}
      for (const v of dynViews) {
        try {
          const m = await import(v.jsFile)
          mods[v.id] = m[v.renderDynamic]
        } catch (e) {
          console.warn('Failed to import dynamic view', v.id, v.jsFile, e)
        }
      }
      setDynamicModules(mods)
    })()
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [JSON.stringify(availableViews.map(v => v.id))])

  const TabBtn = ({ v }) =>
    h('button:text-xs px-1 rounded', {
      className: (activeView === v.id ? 'bg-blue-100 ' : '') + 'text-gray-700 hover:text-gray-900',
      onClick: () => setActiveView(v.id)
    }, v.tabTitle)

  const headerLeft = h('div:flex items-center gap-2', {},
    success ? h('L:Check', { className: 'text-green-600' }) : h('L:X', { className: 'text-red-600' }),
    h('span:font-semibold', { className: !success ? 'text-red-800' : '' }, titleShort),
    h('span:text-gray-500', {}, `(${visits}v)`),
    totalTime != null && h('span:bg-blue-100 text-blue-700 px-1 rounded', {}, `${totalTime}ms`),
    h('span:bg-gray-100 text-gray-600 px-1 rounded', {}, `${logsCount}L`)
  )

  const headerRight = h('div:flex gap-1 items-center', {},
    ...availableViews.map(v => h(TabBtn, { key: v.id, v })),
    h('a:text-xs px-1', { href: location.href }, 'Browser')
  )

  const activeDef = availableViews.find(v => v.id === activeView)

  return h('div:w-full h-full flex flex-col overflow-auto bg-white border rounded shadow-sm text-xs', {},
    // Header
    h('div:sticky top-0 bg-white border-b px-3 py-2 flex items-center justify-between', {
      className: !success ? 'bg-red-50 border-red-200' : ''
    }, headerLeft, headerRight),

    // Path display
    probeRes?.probePath &&
      h('div:text-xs text-gray-600 px-3 py-1 border-b truncate', { title: probeRes.probePath },
        ...probeRes.probePath.split('~').map((elem, i, arr) =>
          i === arr.length - 1
            ? h('span:font-medium', { key: i }, elem)
            : [h('span', { key: `${i}-elem` }, elem), h('span:mx-0.5', { key: `${i}-sep` }, '~')]
        ).flat()
      ),

    // Errors summary strip (when present)
    (Array.isArray(probeRes?.errors) && probeRes.errors.length) && h('div:bg-red-50 border-l-2 border-red-500 px-3 py-1 text-red-700', {},
      h('div:font-medium', {}, 'Errors'),
      h('pre:text-xs overflow-auto mb-1', {}, JSON.stringify(probeRes.errors, null, 1))
    ),

    // Active view body
    activeDef
      ? (activeDef.jsFile
          ? (dynamicModules[activeDef.id]
              ? h(dynamicModules[activeDef.id], { log: coreUtils.resolveRefs(testRes) })
              : h('div:p-4 text-gray-500', {}, `Loading ${activeDef.tabTitle}...`))
          : activeDef.render({ ...props, cmd }))
      : h('div:p-4 text-gray-400', {}, 'No view')
  )
}

/** ---------------- concrete renderers ---------------- **/
function renderResults({ probeRes }) {
  if (!probeRes?.result?.length)
    return h('div:text-gray-500 text-center py-4', {}, 'No results')

  return h('div:p-3 flex flex-col overflow-auto', {},
    probeRes.result.map((r, i) => h(CodeMirrorInputOutput, { key: i, ...r, index: i }))
  )
}

function renderJson({ probeRes }) {
  return h('div:p-3', {},
    h('pre:bg-gray-900 text-green-400 p-2 rounded text-xs overflow-auto max-h-64', {},
      JSON.stringify(probeRes, null, 2)
    )
  )
}

function renderCmd({ cmd, projectDir }) {
  return h('div:p-3', {},
    h('div:mb-2 flex items-center justify-between', {},
      h('span:font-medium text-purple-800', {}, `cd ${projectDir}`),
      h('button:text-purple-600 hover:text-purple-800 text-xs px-2 py-1 border border-purple-300 rounded hover:bg-purple-50', {
        onClick: () => navigator.clipboard.writeText(cmd)
      }, 'Copy')
    ),
    h('pre:bg-gray-900 text-green-400 p-3 rounded text-xs overflow-auto max-h-64 font-mono border border-gray-600 whitespace-pre-wrap', {}, `$ ${cmd}`)
  )
}

function renderError({ error }) {
  return h('div:p-3', {},
    h('div:mb-2 font-medium text-red-800', {}, 'Error:'),
    h('pre:bg-red-50 border border-red-200 p-2 rounded text-xs overflow-auto max-h-64', {},
      typeof error === 'string' ? error : JSON.stringify(error, null, 2)
    )
  )
}

/** ---------------- CodeMirror I/O ---------------- **/
function CodeMirrorInputOutput({ in: In, out }) {
  const inputRef = useRef()
  const outputRef = useRef()
  const containerRef = useRef()
  const [inputWidth, setInputWidth] = useState(50)

  const inputData = In?.data ?? In
  const isHtmlString = typeof inputData === 'string' && inputData.trim().startsWith('<') && inputData.includes('>')

  const handleLayoutChange = (newInputWidth) => {
    setInputWidth(newInputWidth)
    setTimeout(() => {
      const main = containerRef.current
      if (!main) return
      const availableWidth = main.offsetWidth - 20
      const inputW = availableWidth * newInputWidth / 100
      const outputW = availableWidth - inputW
      inputRef.current?.codeMirrorInstance?.setSize(inputW, '100%')
      inputRef.current?.codeMirrorInstance?.refresh()
      outputRef.current?.codeMirrorInstance?.setSize(outputW, '100%')
      outputRef.current?.codeMirrorInstance?.refresh()
    }, 0)
  }

  useEffect(() => {
    if (inputRef.current && !inputRef.current.codeMirrorInstance) {
      let inputValue
      if (isHtmlString) {
        const tempDiv = document.createElement('div')
        tempDiv.innerHTML = inputData
        inputValue = prettyPrintNode(tempDiv)
      } else {
        try {
          inputValue = coreUtils.prettyPrint(inputData)
        } catch {
          inputValue = JSON.stringify(inputData, null, 2)
        }
      }
      inputRef.current.codeMirrorInstance = CodeMirror(inputRef.current, {
        value: inputValue,
        mode: isHtmlString ? 'xml' : 'javascript',
        readOnly: true,
        lineNumbers: true,
        foldGutter: true,
        gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter'],
        extraKeys: {
          'Ctrl-F': 'findPersistent', 'Cmd-F': 'findPersistent',
          'Ctrl-Q': cm => cm.foldCode(cm.getCursor()),
          'Cmd-Q': cm => cm.foldCode(cm.getCursor())
        }
      })
    }

    if (outputRef.current && !outputRef.current.codeMirrorInstance) {
      const outputValue = typeof out === 'object' ? coreUtils.prettyPrint(out) : String(out)
      outputRef.current.codeMirrorInstance = CodeMirror(outputRef.current, {
        value: outputValue,
        mode: 'javascript',
        readOnly: true,
        lineNumbers: true,
        foldGutter: true,
        gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter'],
        extraKeys: {
          'Ctrl-F': 'findPersistent', 'Cmd-F': 'findPersistent',
          'Ctrl-Q': cm => cm.foldCode(cm.getCursor()),
          'Cmd-Q': cm => cm.foldCode(cm.getCursor())
        }
      })
    }

    handleLayoutChange(50)
  }, [In, out, isHtmlString, inputData])

  useEffect(() => {
    const onResize = () => handleLayoutChange(inputWidth)
    window.addEventListener('resize', onResize)
    return () => window.removeEventListener('resize', onResize)
  }, [inputWidth])

  return h('div:flex flex-1 min-h-96 border rounded p-2 mb-2', { ref: containerRef },
    h('div:flex flex-col', {},
      h('div:flex items-center justify-center gap-1 mb-1 h-8', {},
        h('span:font-medium text-gray-600', {}, 'Input:'),
        h('div:flex gap-0.5', {},
          h('button:text-xs px-1 py-0 border rounded hover:bg-gray-50 text-gray-600 leading-none', { onClick: () => handleLayoutChange(20), title: 'Narrow input' }, 'âŸ¨'),
          h('button:text-xs px-1 py-0 border rounded hover:bg-gray-50 text-gray-600 leading-none', { onClick: () => handleLayoutChange(50), title: 'Equal split' }, 'â–£'),
          h('button:text-xs px-1 py-0 border rounded hover:bg-gray-50 text-gray-600 leading-none', { onClick: () => handleLayoutChange(80), title: 'Wide input' }, 'âŸ©'),
          h('button:text-xs px-1 py-0 border rounded hover:bg-gray-50 text-gray-600 leading-none', {
            onClick: () => navigator.clipboard.writeText(inputRef.current?.codeMirrorInstance?.getValue() || ''),
            title: 'Copy input'
          }, 'ðŸ“‹')
        )
      ),
      h('div:h-full', { ref: inputRef })
    ),
    h('div:flex flex-col', {},
      h('div:flex items-center justify-center gap-1 mb-1 h-8', {},
        h('span:font-medium text-gray-600', {}, 'Output:')
      ),
      h('div:h-full', { ref: outputRef })
    )
  )
}
  </script>
</body>
</html>
